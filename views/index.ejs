<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Perpustakaan DPR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <div class="flex min-h-screen">
        <aside class="w-20 lg:w-64 bg-white border-r flex flex-col items-center py-6 shrink-0 shadow-sm">
            <div class="mb-10 text-blue-600 text-3xl font-bold italic">DPR.</div>

            <nav class="flex flex-col space-y-8 items-center lg:items-start w-full px-6">
                <a href="/" class="flex items-center space-x-4 text-blue-600 font-bold group w-full">
                    <div class="p-2 rounded-xl bg-blue-50 group-hover:bg-blue-100 transition-all">
                        <i class="fa-solid fa-table-cells-large text-xl"></i>
                    </div>
                    <span class="hidden lg:block">Dashboard</span>
                </a>

                <% if (user.role === 'admin') { %>
                <a href="/admin" class="flex items-center space-x-4 text-gray-400 hover:text-blue-600 font-bold group w-full transition-all">
                    <div class="p-2 rounded-xl bg-transparent group-hover:bg-blue-50 transition-all">
                        <i class="fa-solid fa-user-shield text-xl"></i>
                    </div>
                    <span class="hidden lg:block">Admin Panel</span>
                </a>
                <% } %>

                <a href="/koleksi" class="relative z-10 flex items-center space-x-4 text-gray-400 hover:text-blue-500 font-bold group w-full transition-all">
                    <div class="p-2 rounded-xl bg-transparent group-hover:bg-blue-50 transition-all">
                        <i class="fa-solid fa-book text-xl"></i>
                    </div>
                    <span class="hidden lg:block">Koleksi</span>
                </a>

                <a href="/logout" class="flex items-center space-x-4 text-gray-400 hover:text-red-500 font-bold group w-full pt-10 transition-all">
                    <div class="p-2 rounded-xl bg-transparent group-hover:bg-red-50 transition-all">
                        <i class="fa-solid fa-right-from-bracket text-xl"></i>
                    </div>
                    <span class="hidden lg:block">Keluar</span>
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-8">
            <div class="flex justify-between items-center mb-10">
                <div>
                    <h1 class="text-3xl font-black text-gray-800 tracking-tight">Dashboard</h1>
                    <p class="text-gray-400 text-sm">Selamat datang kembali, <span class="text-blue-600 font-bold"><%= user.nama %></span>!</p>
                </div>
                
                <div class="w-1/3 bg-white border border-gray-200 rounded-2xl px-4 py-3 flex items-center shadow-sm focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                    <i class="fa-solid fa-magnifying-glass text-gray-300 mr-3"></i>
                    <input type="text" id="searchInput" placeholder="Cari judul buku atau penulis..." class="outline-none text-sm w-full bg-transparent">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-blue-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">Total Buku</p>
                            <h3 class="text-4xl font-black text-gray-800"><%= stats.totalBuku %></h3>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-2xl text-blue-500">
                            <i class="fa-solid fa-book-bookmark text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-emerald-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">Stok Tersedia</p>
                            <h3 class="text-4xl font-black text-gray-800"><%= stats.stokTersedia %></h3>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-2xl text-emerald-500">
                            <i class="fa-solid fa-check-double text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-orange-500 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">Sedang Dipinjam</p>
                            <h3 class="text-4xl font-black text-gray-800"><%= stats.sedangDipinjam %></h3>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-2xl text-orange-500">
                            <i class="fa-solid fa-hand-holding-heart text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-end mb-6">
                <h2 class="text-xl font-bold flex items-center">
                    <i class="fa-solid fa-layer-group mr-2 text-blue-500"></i> Katalog Terbaru (24 Jam)
                </h2>
            </div>
            
            <div id="bookGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8 mb-12">
                <% if (daftarBuku.length > 0) { %>
                    <% daftarBuku.forEach(buku => { %>
                        <div class="bg-white p-4 rounded-[2.5rem] shadow-sm border border-gray-100 group hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative">
                            <div class="aspect-[3/4] bg-gradient-to-tr from-blue-700 to-indigo-500 rounded-[2rem] mb-4 flex items-center justify-center p-6 text-center relative overflow-hidden">
                                <span class="text-white font-bold text-sm leading-tight drop-shadow-md tracking-tight"><%= buku.judul %></span>
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center transition-all duration-300 backdrop-blur-sm">
                                    <% if (buku.stok > 0) { %>
                                        <form action="/pinjam/<%= buku.id %>" method="POST">
                                            <button type="submit" class="bg-white text-blue-600 px-6 py-2 rounded-xl font-bold text-xs hover:scale-110 transition-transform shadow-lg">PINJAM SEKARANG</button>
                                        </form>
                                    <% } else { %>
                                        <span class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold text-xs shadow-lg uppercase">Stok Habis</span>
                                    <% } %>
                                </div>
                            </div>
                            <div class="px-2">
                                <h3 class="font-bold text-sm text-gray-800 truncate" title="<%= buku.judul %>"><%= buku.judul %></h3>
                                <p class="text-[10px] text-gray-400 font-medium mb-2 truncate"><%= buku.penulis %></p>
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-black <%= buku.stok > 0 ? 'text-emerald-500' : 'text-red-500' %>">
                                        ● <%= buku.stok %> Tersedia
                                    </span>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="col-span-full py-12 text-center bg-white rounded-[2rem] border border-dashed border-gray-200 text-gray-400 italic">
                        Tidak ada buku yang baru ditambahkan hari ini. Cek menu <a href="/koleksi" class="text-blue-500 underline font-bold">Koleksi</a> untuk semua buku.
                    </div>
                <% } %>
            </div>

            <h2 class="text-xl font-bold mb-6 flex items-center text-gray-800"><i class="fa-solid fa-clock-rotate-left mr-2 text-orange-500"></i> Riwayat Pinjaman Anda</h2>
            <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50/50 border-b border-gray-100">
                        <tr class="text-gray-400 text-[10px] uppercase font-bold tracking-widest">
                            <th class="px-8 py-5">Judul Buku</th>
                            <th class="px-8 py-5">Tanggal Pinjam</th>
                            <th class="px-8 py-5">Status / Batas Waktu</th>
                            <th class="px-8 py-5">Denda</th>
                            <th class="px-8 py-5 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        <% if (riwayatPinjam.length > 0) { %>
                            <% riwayatPinjam.forEach(item => { %>
                                <tr class="hover:bg-gray-50/50 transition-colors group">
                                    <td class="px-8 py-5">
                                        <p class="font-bold text-sm text-gray-800"><%= item.judul %></p>
                                    </td>
                                    <td class="px-8 py-5 text-xs text-gray-500 font-medium">
                                        <%= new Date(item.tgl_pinjam).toLocaleDateString('id-ID') %>
                                    </td>
                                    <td class="px-8 py-5">
                                        <% if (item.status === 'dipinjam') { %>
                                            <% if (item.sisa_hari > 2) { %>
                                                <span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full"><%= item.sisa_hari %> Hari lagi</span>
                                            <% } else if (item.sisa_hari <= 2 && item.sisa_hari >= 0) { %>
                                                <span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full animate-pulse deadline-alert">Deadline: <%= item.sisa_hari %> Hari!</span>
                                            <% } else { %>
                                                <span class="text-[10px] font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full text-xs">Terlambat <%= Math.abs(item.sisa_hari) %> Hari</span>
                                            <% } %>
                                        <% } else { %>
                                            <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full text-xs">Selesai</span>
                                        <% } %>
                                    </td>
                                    <td class="px-8 py-5">
                                        <% if (item.denda > 0) { %>
                                            <span class="text-xs font-black text-red-500 bg-red-50 px-3 py-1 rounded-lg">Rp <%= item.denda.toLocaleString() %></span>
                                        <% } else { %>
                                            <span class="text-xs text-gray-300">-</span>
                                        <% } %>
                                    </td>
                                    <td class="px-8 py-5 text-center">
                                        <% if (item.status === 'dipinjam') { %>
                                            <form action="/kembali/<%= item.id %>" method="POST">
                                                <button type="submit" class="bg-red-50 text-red-500 hover:bg-red-600 hover:text-white px-6 py-2 rounded-xl text-[10px] font-bold transition-all shadow-sm">KEMBALIKAN</button>
                                            </form>
                                        <% } else { %>
                                            <div class="flex items-center justify-center space-x-1 text-emerald-500">
                                                <i class="fa-solid fa-circle-check text-xs"></i>
                                                <span class="text-[10px] font-bold uppercase tracking-tighter">Sudah Kembali</span>
                                            </div>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="5" class="px-8 py-12 text-center text-gray-400 italic text-sm">Belum ada peminjaman.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // LIVE SEARCH SCRIPT
        const searchInput = document.getElementById('searchInput');
        const bookGrid = document.getElementById('bookGrid');

        searchInput.addEventListener('input', async (e) => {
            const query = e.target.value;
            const res = await fetch(`/search?q=${query}`);
            const buku = await res.json();

            if(buku.length === 0) {
                bookGrid.innerHTML = `<div class="col-span-full py-12 text-center text-gray-400 italic">Buku "${query}" tidak ditemukan.</div>`;
                return;
            }

            bookGrid.innerHTML = buku.map(item => `
                <div class="bg-white p-4 rounded-[2.5rem] shadow-sm border border-gray-100 group hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative">
                    <div class="aspect-[3/4] bg-gradient-to-tr from-blue-700 to-indigo-500 rounded-[2rem] mb-4 flex items-center justify-center p-6 text-center relative overflow-hidden">
                        <span class="text-white font-bold text-sm leading-tight drop-shadow-md tracking-tight">${item.judul}</span>
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center transition-all duration-300 backdrop-blur-sm">
                            ${item.stok > 0 ? `
                                <form action="/pinjam/${item.id}" method="POST">
                                    <button type="submit" class="bg-white text-blue-600 px-6 py-2 rounded-xl font-bold text-xs hover:scale-110 transition-transform shadow-lg">PINJAM SEKARANG</button>
                                </form>` : 
                                `<span class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold text-xs shadow-lg uppercase">Stok Habis</span>`}
                        </div>
                    </div>
                    <div class="px-2">
                        <h3 class="font-bold text-sm text-gray-800 truncate" title="${item.judul}">${item.judul}</h3>
                        <p class="text-[10px] text-gray-400 font-medium mb-2 truncate">${item.penulis}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black ${item.stok > 0 ? 'text-emerald-500' : 'text-red-500'}">
                                ● ${item.stok} Tersedia
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        });

        // NOTIFIKASI DEADLINE
        document.addEventListener('DOMContentLoaded', function() {
            const deadlines = document.querySelectorAll('.deadline-alert').length;
            if (deadlines > 0) {
                alert("Pemberitahuan: Anda memiliki " + deadlines + " peminjaman yang mendekati batas waktu. Mohon segera kembalikan!");
            }
        });

        // RELOAD ON BACK
        window.addEventListener('pageshow', function (event) {
            if (event.persisted || (typeof window.performance != 'undefined' && window.performance.navigation.type === 2)) {
                window.location.reload();
            }
        });
    </script>
</body>
</html>